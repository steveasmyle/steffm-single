<html lang="en" prefix="og: https://ogp.me/ns#">
   <head>
      <!DOCTYPE html>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=9">
      <meta property="og:image" content="images/social480.jpg">
      <meta property="og:image:width" content="480">
      <meta property="og:image:height" content="252">
      <meta property="og:image" content="images/socialFull.jpg">
      <meta property="og:image:width" content="1200">
      <meta property="og:image:height" content="630">
      <meta name="description" content="Stef.FM v2">
      <link rel="shortcut icon" href="favicon.ico">
      <!--[if !IE]>-->
      <link rel="stylesheet" href="calc.screen.css" media="screen">
      <link rel="icon" href="vanilla.svg" type="image/svg+xml">
      <link rel="apple-touch-icon" href="apple-touch-icon.png">
      <link rel="mask-icon" href="vanilla.mask.svg" color="#EC8"><q> </q>
      <!--<![endif]-->
      <title>Stef.FM</title>
   </head>
   <body>
      <div id="fauxBody">
         <div id="stateDisplay"><pre><code></code></pre></div>
         <h1>Stef.FM</h1>
         <!-- #fauxBody -->
         <section class="player">
            <div class="power">POWER</div>
            <h2>STEF&nbsp;.&nbsp;FM<span>9000</span></h2>
            <output>
               <var id="displayMain"></var> <span></span>
            </output>
            <ul class="flags">
               <li id="flagSkipBackward" title="Skip backward" data-text="⏮" class="smallGlyph"></li>
               <li id="flagReverse" title="Reverse" data-text="⏴⏴" class="smallGlyph"></li>
               <li id="flagStop" title="Stop" data-text="⏹" class="smallGlyph"></li>
               <li id="flagPause" title="Pause" data-text="⏸" class="smallGlyph"></li>
               <li id="flagPlay" title="Play" data-text="⏵" class="smallGlyph"></li>
               <li id="flagFastForward" title="Fast forward" data-text="⏵⏵" class="smallGlyph"></li>
               <li id="flagSkipForward" title="Skip forward" data-text="⏭" class="smallGlyph"></li>
               <li id="flagError" title="An error has occurred" data-text="ERR"></li>
            </ul>
            <fieldset>
               <button id="up" class="blue" value="Up">
                  <span>↑</span>
               </button>
               <button id="enter" class="brown tall" value="Enter">
                  <span>↵</span>
               </button>
               <button id="down" class="blue" value="Down">
                  <span>↓</span>
               </button>
            </fieldset>
            <fieldset>
               <button id="stop" class="action red" value="Stop">
                  <span>⏹</span>
               </button>
               <button id="play" class="action orange index wide" value="Play">
                  <span>⏵</span>
               </button>
               <button id="pause" class="grey" value="Pause">
                  <span>⏸</span>
               </button>
            </fieldset>
            <fieldset>
               <button id="skipBackward" class="lightGrey" value="Skip backward">
                  <span>⏮</span>
               </button>
               <button id="rewind" class="lightGrey" value="Rewind">
                  <span>⏴⏴</span>
               </button>
               <button id="fastForward" class="lightGrey" value="Fast forward">
                  <span>⏵⏵</span>
               </button>
               <button id="skipForward" class="lightGrey" value="Skip forward">
                  <span>⏭</span>
               </button>
            </fieldset>
            <div class="mixcloud">
               <div id="mixcloudWidgetWrapper">
                  <iframe id="mixcloudWidget" width="100%" height="60" src="https://www.mixcloud.com/widget/iframe/?hide_cover=1&mini=1&hide_artwork=1&autoplay=1&feed=%2Frymixxx%2Fmy-pair-of-shoes-volume-89%2F" frameborder="0" allow="autoplay"></iframe>
               </div>
            </div>
         </section>
         <section class="playlist">
            <div class="power">&nbsp;</div>
            <h2>STEF&nbsp;.&nbsp;FM<span>9001</span></h2>
            <output>
               <div id="playlistDisplay" tabindex="0">
                  <ul id="categoryList"></ul>
                  <ul id="mixList"></ul>
               </div>
            </output>
            <fieldset class="nav">
               <button id="testButton" class="blank" value="Blank">
                  <span></span>
               </button>
               <button id="upButton" class="blue" value="Up">
                  <span>↑</span>
               </button>
               <button class="blank" value="Blank">
                  <span></span>
               </button>
               <button id="leftButton" class="blue" value="Left">
                  <span>←</span>
               </button>
               <button id="downButton" class="blue" value="Down">
                  <span>↓</span>
               </button>
               <button id="rightButton" class="blue" value="Right">
                  <span>→</span>
               </button>
            </fieldset>         </section>
      </div>
      <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
      <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
      <script src="https://widget.mixcloud.com/media/js/widgetApi.js" type="text/javascript"></script>
      <script>
// --- GLOBAL CONSTANTS AND VARIABLES ---
const config = {
   "iframeUrlPrefix": "https://www.mixcloud.com/widget/iframe/?hide_cover=1&mini=1&hide_artwork=1&autoplay=1&feed=%2Frymixxx%2F",
   "volumeIncrement": 0.05,
   "loadMixcloud": true,
   "keyHold": {
      "repeatInterval": 100,
      "initialDelay": 500
   },
   "output": {
      "characterCount": 12,
      "tickInterval": 250,
      "repeatInterval": 500
   },
   "perspective": {
      "bodyMin": 25,
      "bodyMax": 30,
      "fauxBodyMin": 15,
      "fauxBodyMax": 45
   }
};

let globalError = false;

// TICKER
var scrollers = {};

function startScroller(id, text, displayLength, tickDelay, pauseDelay) {
    var str = text.replace(/ /g, "!");
    str = str.padStart(displayLength + str.length, "!");

    var display = document.getElementById(id);
    var startIndex = 0;

    if (scrollers[id]) {
        clearInterval(scrollers[id]);
    }

    scrollers[id] = setInterval(function() {
        var substring = str.substring(startIndex, startIndex + displayLength);
        display.nextSibling.textContent = substring;
        startIndex++;

        if (startIndex > str.length) {
            startIndex = 0;
            clearInterval(scrollers[id]);
            setTimeout(function() {
                startScroller(id, text, displayLength, tickDelay, pauseDelay);
            }, pauseDelay);
        }
    }, tickDelay);
}

function stopScrollers() {
    for (var id in scrollers) {
        clearInterval(scrollers[id]);
    }
    scrollers = {};
}

// Start scrollers
startScroller(
   "displayMain", 
   "My Pair of Shoes - Volume 89", 
   config.output.characterCount, 
   config.output.tickInterval, 
   config.output.repeatInterval
);

// To stop all scrollers, call stopScrollers():
// stopScrollers();


// PERSPECTIVE SHIFT
function updatePerspective(bodyMin, bodyMax, fauxBodyMin, fauxBodyMax) {
    var bodyRange = bodyMax - bodyMin;
    var fauxBodyRange = fauxBodyMax - fauxBodyMin;

    document.addEventListener('mousemove', function(event) {
        var mouseY = event.clientY;
        var viewportHeight = window.innerHeight;
        var proportion = mouseY / viewportHeight;
        var bodyPerspective = (bodyRange * proportion) + bodyMin;
        var fauxBodyPerspective = (fauxBodyRange * proportion) + fauxBodyMin;
        document.body.style.perspective = `${bodyPerspective}rem`;
        document.getElementById('fauxBody').style.perspective = `${fauxBodyPerspective}rem`;
    });
}

updatePerspective(
   config.perspective.bodyMin, 
   config.perspective.bodyMax, 
   config.perspective.fauxBodyMin,
   config.perspective.fauxBodyMax
);

// MIXCLOUD
let widget;
let mixState = {
   _currentIndex: 0,
   _currentlyPlayingPage: false,
   _intervalId: null,
   _mixcloudHeaderInfo: null,   
   _mixcloudItemInfo: null,   
   _mixcloudKey: null,
   _previousNumDashes: 0,
   _progress: 0,
   _iframeUrl: "",
   _selectedMixItem: null,
   _status: "paused",
   _timeoutId: null,

   get currentIndex() {
      return this._currentIndex;
   },   
   set currentIndex(value) {
      this._currentIndex = value;
   },

   get currentlyPlayingPage() {
      return this._currentlyPlayingPage;
   },   
   set currentlyPlayingPage(value) {
      this._currentlyPlayingPage = value;
   },

   get intervalId() {
      return this._intervalId;
   },   
   set intervalId(value) {
      this._intervalId = value;
   },

   get mixcloudHeaderInfo() {
      return this._mixcloudHeaderInfo;
   },   
   set mixcloudHeaderInfo(value) {
      this._mixcloudHeaderInfo = value;
   },

   get mixcloudItemInfo() {
      return this._mixcloudHeaderInfo;
   },
   set mixcloudItemInfo(value) {
      this._mixcloudHeaderInfo = value;
   },

   get mixcloudKey() {
      return this._mixcloudKey;
   },
   set mixcloudKey(value) {
      this._mixcloudKey = value;
      this._iframeUrl = config.iframeUrlPrefix + encodeURIComponent(value + "/");
      
      // Search for the corresponding item in mixcloudItemInfo
      const mixcloudHeaderItem = mixState.mixcloudItemInfo.data.find(item => item.mixcloudKey === value);

      // Store the found item in _mixcloudHeaderInfo
      if(mixcloudHeaderItem) {
         this._mixcloudItemInfo = mixcloudHeaderItem;
      } else {
         console.warn('No mixcloudHeaderInfo item found for the provided mixcloudKey');
      }

      this.updateDisplay();
      this.updateScroller();
   },

   get previousNumDashes() {
      return this._previousNumDashes;
   },
   set previousNumDashes(value) {
      this._previousNumDashes = value;
      this.updateDisplay();
   },

   get progress() {
      return this._status;
   },
   set progress(value) {
      this._progress = value;
      this.updateDisplay();
   },

   get iframeUrl() {
      return this._iframeUrl;
   },
   set iframeUrl(value) {
      this._iframeUrl = value;
      this.updateDisplay();
   },

   get selectedMixItem() {
      return this._selectedMixItem;
   },   
   set selectedMixItem(value) {
      this._selectedMixItem = value;
   },

   get status() {
      return this._status;
   },
   set status(value) {
      this._status = value;
      this.updateDisplay();
   },

   updateDisplay() {
      const displayDiv = document.querySelector('#stateDisplay pre code');
      displayDiv.innerHTML = JSON.stringify(this, null, 2);
   },
   updateScroller() {
      startScroller(
         "displayMain", 
         this._mixcloudItemInfo.name, 
         config.output.characterCount, 
         config.output.tickInterval, 
         config.output.repeatInterval
      );
   },

   get timeoutId() {
      return this._timeoutId;
   },   
   set timeoutId(value) {
      this._timeoutId = value;
   }

};

function initWidget() {
    widget = Mixcloud.PlayerWidget(document.getElementById("mixcloudWidget"));
    
    widget.ready.then(function() {
        console.log("Mixcloud widget ready");

        const upButton = document.getElementById('up');
        const downButton = document.getElementById('down');

        upButton.addEventListener('mousedown', function() {
            volumeUp();
            mixState.timeoutId = setTimeout(function() {
            mixStateintervalId = setInterval(volumeUp, config.keyHold.repeatInterval);
            }, config.keyHold.initialDelay);
        });

        downButton.addEventListener('mousedown', function() {
            volumeDown();
            mixState.timeoutId = setTimeout(function() {
            mixState.intervalId = setInterval(volumeDown, config.keyHold.repeatInterval);
            }, config.keyHold.initialDelay);
        });

        upButton.addEventListener('mouseup', stopChangingVolume);
        downButton.addEventListener('mouseup', stopChangingVolume);

        document.getElementById('enter').addEventListener('click', enter);
        document.getElementById('stop').addEventListener('click', stop);
        document.getElementById('play').addEventListener('click', play);
        document.getElementById('pause').addEventListener('click', pause);
        document.getElementById('skipBackward').addEventListener('click', skipBackward);
        document.getElementById('rewind').addEventListener('click', rewind);
        document.getElementById('fastForward').addEventListener('click', fastForward);
        document.getElementById('skipForward').addEventListener('click', skipForward);

        widget.events.pause.on(pauseListener);
        widget.events.play.on(playListener);
        widget.events.progress.on(progressListener, widget.getDuration());
    });
}

function stopChangingVolume() {
    clearTimeout(mixState.timeoutId);
    clearInterval(mixState.intervalId);
}

function volumeUp() {
    widget.getVolume().then(volume => {
        if (volume + config.volumeIncrement <= 1) {
            widget.setVolume(volume + config.volumeIncrement);
        } else {
            widget.setVolume(1);
        }
    });
}

function volumeDown() {
    widget.getVolume().then(volume => {
        if (volume - config.volumeIncrement >= 0) {
            widget.setVolume(volume - config.volumeIncrement);
        } else {
            widget.setVolume(0);
        }
    });
}

function loadNewMix(mixcloudKey) {
    mixState.mixcloudKey = mixcloudKey;

    var widgetElement = document.getElementById('mixcloudWidget');
    widgetElement.parentNode.removeChild(widgetElement);

    var newWidgetElement = document.createElement('iframe');
    newWidgetElement.id = 'mixcloudWidget';
    newWidgetElement.width = '100%';
    newWidgetElement.height = '60';
    newWidgetElement.src = mixState.iframeUrl;
    newWidgetElement.frameBorder = '0';
    newWidgetElement.allow = 'autoplay';
    document.getElementById('mixcloudWidgetWrapper').appendChild(newWidgetElement);

    initWidget();
}

function pauseListener() {
    flagPlay.innerHTML = "";
    flagPause.innerHTML = "⏸";
}

function playListener() {
   flagPause.innerHTML = "";
   flagPlay.innerHTML = "⏵";
}

function progressListener(progress, duration) {
   mixState.progress = progress;
   const scale = 11 / duration;
   const numDashes = Math.max(1, Math.ceil(progress * scale));

   if (numDashes !== mixState.previousNumDashes) {
      const progressDiv = document.querySelector('#displayMain + span');
      const dashes = '-'.repeat(numDashes);
      progressDiv.textContent = dashes;
      mixState.previousNumDashes = numDashes;
   }
}

function enter() {
    // your enter function code here
}

function stop() {
    // your stop function code here
}

function play() {
    widget.play();
}

function pause() {
    widget.pause();
}

function skipBackward() {
    loadNewMix("my-pair-of-shoes-volume-87");
}

function rewind() {
    // your rewind function code here
}

function fastForward() {
    // your fastForward function code here
}

function skipForward() {
    loadNewMix("my-pair-of-shoes-volume-88");
}

function selectRandomTrack() {
   const randomIndex = Math.floor(Math.random() * mixState.mixcloudHeaderInfo.data.length);
   const randomItem = mixState.mixcloudHeaderInfo.data[randomIndex];
   loadNewMix(randomItem.mixcloudKey);
}

// When the page first loads, we display the category list.
window.onload = function() {
    // populateCategoryList();
}

// Populate category list
function populateCategoryList() {
  let categoryList = document.getElementById("categoryList");
  let mixList = document.getElementById("mixList");

  // Clear lists
  while (categoryList.firstChild) categoryList.removeChild(categoryList.firstChild);
  while (mixList.firstChild) mixList.removeChild(mixList.firstChild);

  // Show category list, hide mix list
  categoryList.style.display = "block";
  mixList.style.display = "none";

  // Add 'All' option
  let allOption = document.createElement("li");
  allOption.textContent = "All";
  allOption.onclick = () => populateMixList(null);
  categoryList.appendChild(allOption);

  // Add 'Currently Playing' option at the top
  let currentlyPlayingOption = document.createElement("li");
  currentlyPlayingOption.textContent = "Currently Playing";
  currentlyPlayingOption.onclick = populateCurrentlyPlaying;
  categoryList.prepend(currentlyPlayingOption);

  // Add categories
  let categories = mixState.mixcloudHeaderInfo.categories.sort((a, b) => a.name.localeCompare(b.name));
  categories.forEach((item, index) => {
    let li = document.createElement("li");
    li.textContent = item.name;
    li.onclick = () => populateMixList(item.code);
    categoryList.appendChild(li);
  });

  // Set initial active item
  setCurrentActiveItem(categoryList, 0);
}

// Populate mix list
function populateMixList(category) {
  let categoryList = document.getElementById("categoryList");
  let mixList = document.getElementById("mixList");

  // Show mix list, hide category list
  categoryList.style.display = "none";
  mixList.style.display = "block";

  // Add 'Back' option
  let backOption = document.createElement("li");
  backOption.textContent = "Back";
  backOption.onclick = populateCategoryList;
  mixList.appendChild(backOption);

  // Add 'Currently Playing' option at the top
  let currentlyPlayingOption = document.createElement("li");
  currentlyPlayingOption.textContent = "Currently Playing";
  currentlyPlayingOption.onclick = populateCurrentlyPlaying;
  mixList.prepend(currentlyPlayingOption);

  // Add mixes
  let mixes = mixState.mixcloudHeaderInfo.data;
  if (category) mixes = mixes.filter(item => item.category === category);
  mixes.sort((a, b) => a.shortName.localeCompare(b.shortName)).forEach(item => {
    let li = document.createElement("li");
    li.textContent = item.shortName;
    li.onclick = () => {
      mixState.mixcloudKey = item.mixcloudKey;
      loadNewMix(mixState.mixcloudKey);
      if (mixState.selectedMixItem) mixState.selectedMixItem.classList.remove('selected');
      li.classList.add('selected');
      mixState.selectedMixItem = li;
      populateCurrentlyPlaying();
    };
    if (mixState.mixcloudKey === item.mixcloudKey) {
      li.classList.add('selected');
      mixState.selectedMixItem = li;
    }
    mixList.appendChild(li);
  });

  // Set initial active item
  if (mixState.mixcloudKey) {
    let index = mixes.findIndex(item => item.mixcloudKey === mixState.mixcloudKey);
    setCurrentActiveItem(mixList, index !== -1 ? index + 1 : 0);  // Add 1 to index to account for 'Back' option
  } else {
    setCurrentActiveItem(mixList, 0);
  }
}

// Populate 'Currently Playing' page
function populateCurrentlyPlaying() {
  let mixList = document.getElementById("mixList");

  // Clear list
  while (mixList.firstChild) mixList.removeChild(mixList.firstChild);

  // Show 'Currently Playing' page, hide category list
  document.getElementById("categoryList").style.display = "none";
  mixList.style.display = "block";

  // Add 'Back' option
  let backOption = document.createElement("li");
  backOption.textContent = "Back";
  backOption.onclick = () => {
    mixState.currentlyPlayingPage = false;
    if (mixState.mixcloudKey) populateMixList();
    else populateCategoryList();
  };
  mixList.appendChild(backOption);

  // Add currently playing mix name
  let mixName = document.createElement("li");
  mixName.textContent = mixState.mixcloudHeaderInfo.data.find(item => item.mixcloudKey === mixState.mixcloudKey).shortName;
  mixList.appendChild(mixName);

  // Set initial active item
  setCurrentActiveItem(mixList, 1);

  mixState.currentlyPlayingPage = true;
}

async function fetchTracklist() {
  try {
    let response = await fetch("tracklist.json");
    let data = await response.json();
    return data;
  } catch (err) {
    console.error(err);
  }
}

function getOffsetTop(elem, parent) {
    let offsetTop = 0;
    do {
        if (!isNaN(elem.offsetTop)) {
            offsetTop += elem.offsetTop;
        }
    } while(elem = elem.offsetParent);
    return offsetTop;
}

// Set current active item
function setCurrentActiveItem(parent, index) {
  let items = parent.getElementsByTagName("li");
  for (let item of items) item.classList.remove("active");

  if (items.length > 0) {
    items[index].classList.add("active");
    mixState.currentIndex = index;

    let playlistDisplay = document.querySelector('#playlistDisplay');
    let activeElement = items[index];
    
    let topPosition = getOffsetTop(activeElement, playlistDisplay) - (playlistDisplay.offsetHeight / 2) + (activeElement.offsetHeight / 2);
    let maxScrollTop = playlistDisplay.scrollHeight - playlistDisplay.clientHeight;
    let adjustedTopPosition = Math.min(Math.max(topPosition, 0), maxScrollTop);
    playlistDisplay.scrollTo({ top: topPosition, behavior: 'smooth' });
  }
}

// Navigate up/down options
function navigateOption(direction) {
  let parent = document.getElementById("categoryList").style.display === "block" ? "categoryList" : "mixList";
  let items = document.getElementById(parent).getElementsByTagName("li");
  mixState.currentIndex += direction;
  if (mixState.currentIndex < 0) currentIndex = 0;
  if (mixState.currentIndex >= items.length) mixState.currentIndex = items.length - 1;
  setCurrentActiveItem(document.getElementById(parent), mixState.currentIndex);
}

// Navigate left (go back)
function navigateLeft() {
  if (mixState.currentlyPlayingPage) {
    mixState.currentlyPlayingPage = false;
    if (mixState.mixcloudKey) populateMixList();
    else populateCategoryList();
  } else if (document.getElementById("mixList").style.display === "block") populateCategoryList();
}

// Navigate right (select option)
function navigateRight() {
  let parent = document.getElementById("categoryList").style.display === "block" ? "categoryList" : "mixList";
  let items = document.getElementById(parent).getElementsByTagName("li");

  // Handle 'Currently Playing' option separately
  if (items[mixState.currentIndex].textContent === "Currently Playing") populateCurrentlyPlaying();
  else items[mixState.currentIndex].click();
}

// Listen for keypresses
document.addEventListener("keydown", e => {
  switch (e.code) {
    case "ArrowUp": navigateOption(-1); break;
    case "ArrowDown": navigateOption(1); break;
    case "ArrowRight": navigateRight(); break;
    case "ArrowLeft": navigateLeft(); break;
    case "Enter": navigateRight(); break;
  }
});

// Prevent default
playlistDisplay.addEventListener('keydown', function(e) {
  if (['ArrowUp', 'ArrowDown'].includes(e.key)) {
    e.preventDefault();
  }
});

// Button press handlers
let upButton = document.getElementById("upButton");
let downButton = document.getElementById("downButton");
let rightButton = document.getElementById("rightButton");
let leftButton = document.getElementById("leftButton");

upButton.addEventListener("click", () => navigateOption(-1));
downButton.addEventListener("click", () => navigateOption(1));
rightButton.addEventListener("click", navigateRight);
leftButton.addEventListener("click", navigateLeft);

// init
fetch('mixesheader.json')
    .then(response => {
        if (!response.ok) {
            throw new Error("HTTP error " + response.status);
        }
        return response.json();
    })
    .then(json => {
        mixState.mixcloudHeaderInfo = json;
        
        if (config.loadMixcloud) {
         selectRandomTrack();
        }

        populateCategoryList();
    })
    .catch(function(err) {
        console.log("Failed to load mixesheader.json file", err);
        globalError = true;
    });

if (config.loadMixcloud) {
   initWidget();
}

document.body.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() === 'li' && event.target.classList.contains('mix-item')) {
        loadNewMix(event.target.getAttribute('data-key'));
    }
});
     </script>
   </body>
</html>