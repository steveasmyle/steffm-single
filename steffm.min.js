const config={iframeUrlPrefix:"https://www.mixcloud.com/widget/iframe/?hide_cover=1&mini=1&hide_artwork=1&autoplay=1&feed=%2Frymixxx%2F",volumeIncrement:.05,loadMixcloud:!0,keyHold:{repeatInterval:100,initialDelay:500},output:{characterCount:12,tickInterval:250,repeatInterval:500},perspective:{bodyMin:27,bodyMax:28,fauxBodyMin:20,fauxBodyMax:30}},articles=[{title:"Stef.FM Relaunch",body:"Stef.FM has a new retro vibe. Enjoy the new interface and let the tunes do the talking.",author:"Stef.FM",date:"31 July 2023"},{title:"About Stef.FM",body:"Stef.FM is a music streaming service dedicated to preserving the works of the late music genius, Stefan Bauer. Explore and enjoy his vast collection of house, soul, and jazz mixes.",author:"Stef.FM",date:"23 July 2023"}];let globalError=!1;var scrollers={};function startScroller(e,t,i,n,a){var r=t.replace(/ /g,"!");r=r.padStart(i+r.length,"!");var l=document.getElementById(e),o=0;scrollers[e]&&clearInterval(scrollers[e]),scrollers[e]=setInterval((function(){var c=r.substring(o,o+i);l.nextSibling.textContent=c,++o>r.length&&(o=0,clearInterval(scrollers[e]),setTimeout((function(){startScroller(e,t,i,n,a)}),a))}),n)}function stopScrollers(){for(var e in scrollers)clearInterval(scrollers[e]);scrollers={}}function updatePerspective(e,t,i,n){var a=t-e,r=n-i;document.addEventListener("mousemove",(function(t){if(window.matchMedia("(min-width: 64rem)").matches){var n=t.clientY/window.innerHeight,l=a*n+e,o=r*n+i;document.body.style.perspective=`${l}rem`,document.getElementById("fauxBody").style.perspective=`${o}rem`}else document.body.style.perspective="unset",document.getElementById("fauxBody").style.perspective="unset"}))}let widget;startScroller("displayMain","",config.output.characterCount,config.output.tickInterval,config.output.repeatInterval),updatePerspective(config.perspective.bodyMin,config.perspective.bodyMax,config.perspective.fauxBodyMin,config.perspective.fauxBodyMax);let mixState={_currentlyPlayingPage:!1,_currentVolume:.8,_intervalId:null,_lastPage:"categoryList",_lastActiveTrack:null,_mixcloudHeaderInfo:null,_mixcloudTracklist:null,_mixcloudItemInfo:null,_mixcloudKey:null,_previousNumDashes:0,_progress:0,_iframeUrl:"",_selectedMixItem:null,_status:"paused",_timeoutId:null,_articles:[],_indices:{categoryList:0,mixList:0,trackList:0,articleList:0,article:article},get currentlyPlayingPage(){return this._currentlyPlayingPage},set currentlyPlayingPage(e){this._currentlyPlayingPage=e},get currentVolume(){return this._currentVolume},set currentVolume(e){this._currentVolume=e;let t=document.getElementById("displayMain"),i=Math.round(11*e),n="";for(let e=0;e<i;e++)n+="-<br>";t.innerHTML=n},get intervalId(){return this._intervalId},set intervalId(e){this._intervalId=e},get lastPage(){return this._lastPage},set lastPage(e){this._lastPage=e},get lastActiveTrack(){return this._lastActiveTrack},set lastActiveTrack(e){this._lastActiveTrack=e},get mixcloudHeaderInfo(){return this._mixcloudHeaderInfo},set mixcloudHeaderInfo(e){this._mixcloudHeaderInfo=e},get mixcloudTracklist(){return this._mixcloudTracklist},set mixcloudTracklist(e){this._mixcloudTracklist=e},get mixcloudItemInfo(){return this._mixcloudItemInfo},set mixcloudItemInfo(e){this._mixcloudItemInfo=e},get mixcloudKey(){return this._mixcloudKey},set mixcloudKey(e){this._mixcloudKey=e,this._iframeUrl=config.iframeUrlPrefix+encodeURIComponent(e+"/");const t=mixState.mixcloudHeaderInfo.data.find((t=>t.mixcloudKey===e));t?this._mixcloudItemInfo=t:console.warn("No mixcloudHeaderInfo item found for the provided mixcloudKey"),this.updateDisplay(),this.updateScroller()},get previousNumDashes(){return this._previousNumDashes},set previousNumDashes(e){this._previousNumDashes=e,this.updateDisplay()},get progress(){return this._status},set progress(e){this._progress=e,this.updateDisplay()},get iframeUrl(){return this._iframeUrl},set iframeUrl(e){this._iframeUrl=e,this.updateDisplay()},get selectedMixItem(){return this._selectedMixItem},set selectedMixItem(e){this._selectedMixItem=e},get status(){return this._status},set status(e){this._status=e,this.updateDisplay()},updateDisplay(){document.querySelector("#stateDisplay pre code").innerHTML=JSON.stringify(this,null,2)},updateScroller(){startScroller("displayMain",this._mixcloudItemInfo.name,config.output.characterCount,config.output.tickInterval,config.output.repeatInterval)},get timeoutId(){return this._timeoutId},set timeoutId(e){this._timeoutId=e},get articles(){return this._articles},set articles(e){Array.isArray(e)?this._articles=e:console.error("Expected an array of articles")},get categoryListIndex(){return this._indices.categoryList},set categoryListIndex(e){this._indices.categoryList=e},get mixListIndex(){return this._indices.mixList},set mixListIndex(e){this._indices.mixList=e},get trackIndex(){return this._indices.track},set trackIndex(e){this._indices.track=e},get articleListIndex(){return this._indices.articleList},set articleListIndex(e){this._indices.articleList=e},get articleIndex(){return this._indices.article},set articleIndex(e){this._indices.article=e}};function stopKeyHold(){clearTimeout(mixState.timeoutId),clearInterval(mixState.intervalId)}function volumeUp(){const e=document.querySelector("#flagVolumeUp");e.textContent="VOL+",setTimeout((function(){e.textContent=""}),500),widget.getVolume().then((e=>{if(e+config.volumeIncrement<=1){let t=e+config.volumeIncrement;mixState.currentVolume=t,widget.setVolume(t)}else mixState.currentVolume=1,widget.setVolume(1)}))}function volumeDown(){const e=document.querySelector("#flagVolumeDown");e.textContent="VOL-",setTimeout((function(){e.textContent=""}),500),widget.getVolume().then((e=>{if(e-config.volumeIncrement>=0){let t=e-config.volumeIncrement;mixState.currentVolume=t,widget.setVolume(t)}else mixState.currentVolume=0,widget.setVolume(0)}))}async function loadNewMix(e){mixState.mixcloudKey=e;for(var t=document.getElementById("mixcloudWidgetWrapper");t.firstChild;)t.removeChild(t.lastChild);var i=document.createElement("iframe");i.id="mixcloudWidget",i.width="100%",i.height="60",i.src=mixState.iframeUrl,i.frameBorder="0",i.allow="autoplay",document.getElementById("mixcloudWidgetWrapper").appendChild(i),await initWidget(),currentMix=mixState.mixcloudHeaderInfo.data.find((t=>t.mixcloudKey===e)),currentMix&&(document.title=`${currentMix.shortName} - Stef.FM`,mixState.updateDisplay(),mixState.updateScroller());let n=mixState.mixcloudHeaderInfo.data.findIndex((t=>t.mixcloudKey===e));n>-1?mixState.currentIndex=n:console.error(`Could not find mix with key ${e} in mixcloudHeaderInfo`),mixState.currentlyPlayingPage=!1,mixState.lastActiveTrack=null,mixState.progress=0,mixState.selectedMixItem=null,mixState.status="paused",mixState.currentVolume=mixState.currentVolume;let a=(await fetchTracklist(e)).tracks;a.forEach((e=>{let t=e.startTime.split(":").map(Number);e.startInSeconds=t.reduce(((e,i,n)=>e+i*Math.pow(60,t.length-n-1)),0)})),mixState.mixcloudTracklist=a}function pauseListener(){flagPlay.innerHTML="",flagPause.innerHTML="PAUSE"}function playListener(){flagPause.innerHTML="",flagPlay.innerHTML="PLAY"}function progressListener(e,t){mixState.progress=e;const i=11/t,n=Math.max(1,Math.ceil(e*i));if(n!==mixState.previousNumDashes){const e=document.querySelector("#displayMain + span"),t="-".repeat(n);e.textContent=t,mixState.previousNumDashes=n}let a=getTrackFromTime(e),r=Array.from(document.querySelectorAll(".titleCard"));0!==r.length&&r.forEach(((e,t)=>{if(e.classList.remove("selected"),mixState.mixcloudTracklist[t-1]===a&&(e.classList.add("selected"),mixState.lastActiveTrack!==a)){const t=document.querySelector("#playlistDisplay"),i=t.offsetHeight/5,n=e.offsetTop-i;t.scrollTo({top:n,behavior:"smooth"}),mixState.lastActiveTrack=a}}))}function endedListener(){selectRandomTrack()}function getTrackFromTime(e){let t=mixState.mixcloudTracklist;return t.forEach((e=>{let t=e.startTime.split(":").map(Number);e.startInSeconds=t.reduce(((e,i,n)=>e+i*Math.pow(60,t.length-n-1)),0)})),t.reduce(((t,i)=>e>=t.startInSeconds&&e<i.startInSeconds?t:i))}function togglePlaylist(){var e=document.querySelector(".playlist"),t=document.getElementById("fauxBody");"none"===e.style.display?(e.style.display="block",t.classList.remove("single")):(e.style.display="none",t.classList.add("single"))}function play(){widget.play()}function pause(){widget.pause()}async function togglePlayPause(){await widget.getIsPaused()?widget.play():widget.pause()}function skipPrevious(){const e=document.querySelector("#flagSkipPrevious");e.textContent="PREV",setTimeout((function(){e.textContent=""}),500),mixState.currentIndex>0&&(mixState.currentIndex--,loadNewMix(mixState.mixcloudHeaderInfo.data[mixState.currentIndex].mixcloudKey))}function skipNext(){const e=document.querySelector("#flagSkipNext");e.textContent="NEXT",setTimeout((function(){e.textContent=""}),500),mixState.currentIndex<mixState.mixcloudHeaderInfo.data.length-1&&(mixState.currentIndex++,loadNewMix(mixState.mixcloudHeaderInfo.data[mixState.currentIndex].mixcloudKey))}function selectRandomTrack(){const e=Math.floor(Math.random()*mixState.mixcloudHeaderInfo.data.length);loadNewMix(mixState.mixcloudHeaderInfo.data[e].mixcloudKey)}function switchView(e){({mixList:["categoryList","currentlyPlaying","articleList","article"],currentlyPlaying:["categoryList","mixList","articleList","article"],categoryList:["mixList","currentlyPlaying","articleList","article"],articleList:["categoryList","mixList","currentlyPlaying","article"],article:["categoryList","mixList","currentlyPlaying","articleList"]})[e].forEach((e=>{let t=document.getElementById(e);for(t&&(t.style.display="none");t.firstChild;)t.removeChild(t.firstChild)})),populateTitle({mixList:"Mixes",currentlyPlaying:"Currently Playing",categoryList:"Home",articleList:"Articles",article:"Article"}[e]);let t=document.getElementById(e);t&&(t.style.display="block")}function showArticle(e,t){e.preventDefault(),populateArticle(t)}function createNavigationElement(e,t){let i=document.createElement("li");return i.textContent=e,i.onclick=t,i}function createOption(e,t,i,n=!1){let a=createNavigationElement(t,i);return n?e.prepend(a):e.appendChild(a),a}function populateTitle(e){const t=document.querySelector("#playlistDisplay > h3");e&&(t.textContent=e)}function populateList(e,t,i,n,a,r){let l=document.getElementById(e);l.innerHTML="",t&&l.appendChild(createNavigationElement("[ Back ]",t)),i&&l.appendChild(createNavigationElement("[ View Currently Playing Mix ]",populateCurrentlyPlaying)),n&&l.appendChild(createNavigationElement("[ Articles ]",populateArticleList)),a.forEach(((e,t)=>{let i=document.createElement("li");i.textContent=e.name||e.title,i.onclick=()=>r(e),l.appendChild(i)})),setCurrentActiveItem(l,mixState[`${e}Index`])}function populateArticleList(){switchView("articleList"),populateList("articleList",populateCategoryList,!1,!1,mixState.articles,(e=>populateArticle(e.title))),mixState.articleIndex=0}function populateArticle(e){switchView("article");let t=mixState.articles.find((t=>t.title===e));if(!t)return void console.error("No article found with title: ",e);let i=document.getElementById("article");i.innerHTML="",createOption(i,"[ Back ]",populateArticleList,!0);let n=document.createElement("li");n.innerHTML=`<h3>${t.title}</h3>By: ${t.author}, ${t.date}<br><br>${t.body}`,i.appendChild(n),mixState.articleIndex=0,setCurrentActiveItem(i,mixState.articleIndex)}function populateCategoryList(){switchView("categoryList"),populateList("categoryList",null,!0,!0,mixState.mixcloudHeaderInfo.categories.sort(((e,t)=>e.name.localeCompare(t.name))),(e=>populateMixList(e.code))),mixState.categoryIndex=0}function populateMixList(e){switchView("mixList");let t=mixState.mixcloudHeaderInfo.data;e&&(t=t.filter((t=>t.category===e))),t.sort(((e,t)=>e.listOrder-t.listOrder));let i=t.map(((e,t)=>({name:e.shortName,onclick:function(){mixState.mixcloudKey=e.mixcloudKey,loadNewMix(mixState.mixcloudKey),mixState.selectedMixItem&&mixState.selectedMixItem.classList.remove("selected"),this.classList.add("selected"),mixState.selectedMixItem=this,populateCurrentlyPlaying(),mixState.mixcloudKey===e.mixcloudKey&&(this.classList.add("selected"),mixState.selectedMixItem=this,mixState.mixIndex=t+2)}})));mixState.mixIndex=0,populateList("mixList",populateCategoryList,!1,!1,i,(e=>e.onclick())),setCurrentActiveItem(document.getElementById("mixList"),mixState.mixListIndex)}function populateArticleList(){switchView("articleList"),mixState.articleListIndex=0,populateList("articleList",populateCategoryList,!1,!1,mixState.articles,(e=>populateArticle(e.title))),setCurrentActiveItem(document.getElementById("articleList"),mixState.articleListIndex)}function getTrackIndexFromTime(e){let t=mixState.mixcloudTracklist;return t.findIndex(((i,n)=>n<t.length-1?e>=i.startInSeconds&&e<t[n+1].startInSeconds:e>=i.startInSeconds))}async function populateCurrentlyPlaying(){switchView("currentlyPlaying");let e=document.getElementById("currentlyPlaying");document.getElementById("categoryList").style.display="none",document.getElementById("mixList").style.display="none",e.style.display="block";let t=document.createElement("li");t.classList.add("nav-item"),t.textContent="[ Back ]",t.onclick=()=>{mixState.currentlyPlayingPage=!1,e.style.display="none",document.getElementById("categoryList").style.display="block",populateCategoryList()},e.appendChild(t),e.appendChild(titleCardMixInfo(mixState.mixcloudItemInfo.coverArtSmall,mixState.mixcloudHeaderInfo.data.find((e=>e.mixcloudKey===mixState.mixcloudKey)).name,mixState.mixcloudItemInfo.duration,mixState.mixcloudItemInfo.releaseDate,mixState.mixcloudItemInfo.notes)),mixState.mixcloudTracklist.forEach(((t,i)=>{e.appendChild(titleCardTrackInfo(t.sectionNumber,t.startTime,t.coverArtSmall,t.trackName,t.artistName,t.publisher,t.remixArtistName))})),setCurrentActiveItem(e,0),mixState.currentlyPlayingPage=!0}function titleCardMixInfo(e,t,i,n,a){let r=document.createElement("li");r.classList.add("titleCard");let l=document.createElement("h3");l.textContent=t,r.appendChild(l);let o=document.createElement("div");o.classList.add("coverArtWrapper");let c=document.createElement("div");c.classList.add("coverArt");let s=document.createElement("img");s.src=e,c.appendChild(s);let d=document.createElement("div");d.classList.add("itemInfo");let u=document.createElement("div");u.textContent=i,d.appendChild(u);let m=document.createElement("div");m.textContent=n,d.appendChild(m);let x=document.createElement("div");return x.classList.add("itemNotes"),x.textContent=a,d.appendChild(x),o.appendChild(c),o.appendChild(d),r.appendChild(o),r}function titleCardTrackInfo(e,t,i,n,a,r,l){let o=document.createElement("li");if(o.classList.add("titleCard"),1===e){let e=document.createElement("h3");e.textContent="Track Listing",o.appendChild(e)}let c=document.createElement("div");c.classList.add("coverArtWrapper");let s=document.createElement("div");if(s.classList.add("coverArt"),i){let e=document.createElement("img");e.src=i,s.appendChild(e)}else{let e=document.createElement("div");e.classList.add("coverArtPlaceholder"),s.appendChild(e)}let d=document.createElement("div");d.classList.add("itemInfo");let u=document.createElement("div");u.textContent=`Track ${e} - ${t}`,d.appendChild(u);let m=document.createElement("h3");m.textContent=n,d.appendChild(m);let x=document.createElement("div");x.textContent=a,d.appendChild(x);let p=document.createElement("div");if(p.textContent=r,d.appendChild(p),l){let e=document.createElement("div");e.classList.add("itemNotes"),e.textContent=`Remixed by ${l}`,d.appendChild(e)}return c.appendChild(s),c.appendChild(d),o.appendChild(c),o}async function fetchTracklist(e){try{let t=await fetch(`mixcloud/tracklist-${e}.json`);return await t.json()}catch(e){console.error(e)}}function getOffsetTop(e,t){let i=0;do{isNaN(e.offsetTop)||(i+=e.offsetTop)}while(e=e.offsetParent);return i}function setCurrentActiveItem(e,t){let i=e.getElementsByTagName("li"),n=e.getAttribute("id");if(void 0!==t)if(t<0||t>=i.length)console.warn(`Invalid index: ${t}`);else{for(let e of i)e.classList.remove("active");if(i.length>0){switch(i[t].classList.add("active"),n){case"categoryList":mixState.categoryIndex=t;break;case"mixList":mixState.mixIndex=t;break;case"currentlyPlaying":mixState.trackIndex=t;break;case"articleList":mixState.articleListIndex=t;break;case"article":mixState.articleIndex=t}let e=document.querySelector("#playlistDisplay"),a=i[t].offsetTop-.1*e.offsetHeight,r=e.scrollHeight-e.clientHeight,l=Math.min(Math.max(a,0),r);e.scrollTo({top:l,behavior:"smooth"})}}else console.error(`Index is undefined for ${n}`)}function navigateOption(e){const t=["categoryList","mixList","currentlyPlaying","articleList","article"];let i,n,a;for(let e=0;e<t.length;e++)if("block"===document.getElementById(t[e]).style.display){i=t[e],n=document.getElementById(i);break}if(!i||!n)return void console.error("No parent found in navigateOption");switch(i){case"categoryList":a=mixState.categoryIndex;break;case"mixList":a=mixState.mixIndex;break;case"currentlyPlaying":a=mixState.trackIndex;break;case"articleList":a=mixState.articleListIndex;break;case"article":a=mixState.articleIndex}let r=a+e,l=n.getElementsByTagName("li").length;r<0?r=l-1:r>=l&&(r=0),setCurrentActiveItem(n,r)}function navigateLeft(){let e=getCurrentView();switch(e){case"mixList":case"currentlyPlaying":case"articleList":populateCategoryList();break;case"article":populateArticleList();break;default:console.warn(`Unhandled left navigation for view: ${e}`)}}mixState.articles=articles;const parentNameToIndexProperty={categoryList:"categoryIndex",mixList:"mixIndex",currentlyPlaying:"trackIndex",articleList:"articleListIndex",article:"articleIndex"};function navigateRight(){let e=getCurrentView(),t=document.getElementById(e).getElementsByTagName("li"),i=parentNameToIndexProperty[e];mixState[i]>=0&&mixState[i]<t.length?t[mixState[i]].click():console.error(`No item found at index: ${mixState[i]} for ${e}`)}function getCurrentView(){for(let e of["categoryList","mixList","currentlyPlaying","articleList","article"])if("block"===document.getElementById(e).style.display)return e}async function initWidget(){widget=Mixcloud.PlayerWidget(document.getElementById("mixcloudWidget")),await widget.ready;const e=document.getElementsByTagName("button");for(let t=0;t<e.length;t++)e[t].addEventListener("focus",(function(){var e;(e=this).classList.add("focus"),setTimeout((function(){e.classList.remove("focus")}),200)}));widget.setVolume(mixState.currentVolume)}async function handleWidgetEvents(){await widget.ready,widget.events&&(widget.events.pause&&widget.events.pause.on(pauseListener),widget.events.play&&widget.events.play.on(playListener),widget.events.progress&&widget.events.progress.on(progressListener,widget.getDuration()),widget.events.ended&&widget.events.ended.on(endedListener))}document.addEventListener("keydown",(e=>{switch(e.code){case"ArrowUp":navigateOption(-1);break;case"ArrowDown":navigateOption(1);break;case"ArrowRight":case"Enter":navigateRight();break;case"ArrowLeft":navigateLeft();break;case"Space":case"KeyK":togglePlayPause();break;case"KeyJ":skipPrevious();break;case"KeyL":skipNext();break;case"KeyA":volumeUp();break;case"KeyZ":volumeDown()}})),playlistDisplay.addEventListener("keydown",(function(e){["ArrowUp","ArrowDown"].includes(e.key)&&e.preventDefault()}));let mutationObserverTargetNode=document.getElementById("mixcloudWidgetWrapper"),mutationObserverConfig={childList:!0},mutationObserverCallback=function(e,t){for(let t of e)if("childList"===t.type)for(let e of t.addedNodes)"iframe"===e.nodeName.toLowerCase()&&"mixcloudWidget"===e.id&&handleWidgetEvents()},widgetObserver=new MutationObserver(mutationObserverCallback);widgetObserver.observe(mutationObserverTargetNode,mutationObserverConfig),window.onload=function(){fetch("mixcloud/mixesheader.json").then((e=>{if(!e.ok)throw new Error("HTTP error "+e.status);return e.json()})).then((e=>{mixState.mixcloudHeaderInfo=e,config.loadMixcloud&&selectRandomTrack(),populateCategoryList()})).catch((function(e){console.log("Failed to load mixcloud/mixesheader.json file",e),globalError=!0})),document.body.addEventListener("click",(function(e){"li"===e.target.tagName.toLowerCase()&&e.target.classList.contains("mix-item")&&loadNewMix(e.target.getAttribute("data-key"))})),document.getElementById("volumeUp").addEventListener("mousedown",volumeUp),document.getElementById("volumeDown").addEventListener("mousedown",volumeDown),document.getElementById("upButton").addEventListener("click",(function(){navigateOption(-1)})),document.getElementById("downButton").addEventListener("click",(function(){navigateOption(1)})),document.getElementById("rightButton").addEventListener("click",navigateRight),document.getElementById("leftButton").addEventListener("click",navigateLeft),document.getElementById("togglePlaylist").addEventListener("click",togglePlaylist),document.getElementById("play").addEventListener("click",play),document.getElementById("pause").addEventListener("click",pause),document.getElementById("skipPrevious").addEventListener("click",skipPrevious),document.getElementById("skipNext").addEventListener("click",skipNext),document.getElementById("shuffle").addEventListener("click",selectRandomTrack),document.getElementById("about").addEventListener("click",(function(e){showArticle(e,"About Stef.FM")}))};